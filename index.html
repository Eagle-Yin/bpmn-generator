<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPMN 流程图查看器</title>
    <!-- 引入bpmn.js及其样式 -->
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@16.9.0/dist/assets/diagram-js.css">
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@16.9.0/dist/assets/bpmn-font/css/bpmn-embedded.css">
    <style>
        #canvas {
            width: 100%;
            height: 600px; /* 给你的流程图一个足够大的画布 */
            border: 1px solid #ccc;
        }
        .message {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .error { background-color: #ffebee; color: #c62828; }
        .success { background-color: #e8f5e9; color: #2e7d32; }
    </style>
</head>
<body>
    <h1>流程设计结果</h1>
    <!-- 用于显示提示信息 -->
    <div id="message"></div>
    <!-- bpmn.js将把图画在这个div里 -->
    <div id="canvas"></div>

    <!-- 引入bpmn.js库 -->
    <script src="https://unpkg.com/bpmn-js@16.9.0/dist/bpmn-viewer.development.js"></script>

    <script>
        // 全局变量，用于存储查看器实例
        let viewer = null;

        // 页面加载完成后执行
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化BPMN查看器
            viewer = new BpmnJS({
                container: '#canvas'
            });

            // 尝试从URL参数中获取BPMN XML数据
            const urlParams = new URLSearchParams(window.location.search);
            // 我们约定URL参数名为`xml`，其值是经过Base64编码的XML字符串
            const encodedBpmnXML = urlParams.get('xml'); 

            if (encodedBpmnXML) {
                try {
                    // 将Base64编码的字符串解码回原始的XML字符串
                    const bpmnXML = atob(encodedBpmnXML);
                    renderDiagram(bpmnXML);
                } catch (error) {
                    showMessage('传入的XML参数格式有误，无法解析。', 'error');
                    console.error(error);
                }
            } else {
                showMessage('未接收到BPMN数据。请从COZE助手再次打开此页面。', 'error');
            }
        });

        // 渲染BPMN图的核心函数
        async function renderDiagram(bpmnXML) {
            try {
                // ！！！重要：清除可能的旧图形
                if (viewer) {
                    viewer.destroy();
                    viewer = new BpmnJS({ container: '#canvas' });
                }

                // 将XML导入查看器
                const { warnings } = await viewer.importXML(bpmnXML);

                if (warnings.length) {
                    console.warn('渲染成功，但有警告:', warnings);
                    showMessage('流程图已生成，但存在一些轻微问题。', 'success');
                } else {
                    showMessage('流程图已成功生成！', 'success');
                }

                // 自动调整画布视角，让流程图居中并适应窗口
                viewer.get('canvas').zoom('fit-viewport');

            } catch (err) {
                console.error('渲染流程图失败:', err);
                showMessage('生成流程图失败，XML格式可能不正确。详情请查看控制台。', 'error');
            }
        }

        // 用于在页面上显示提示信息的工具函数
        function showMessage(text, type = 'info') {
            const messageEl = document.getElementById('message');
            messageEl.textContent = text;
            messageEl.className = `message ${type}`;
        }
    </script>
</body>
</html>
