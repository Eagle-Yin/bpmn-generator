<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BPMN 流程图查看器</title>
    <!-- 引入 bpmn-js 样式 -->
    <link rel="stylesheet" href="https://unpkg.com/bpmn-js@17.0.2/dist/assets/bpmn-js.css">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            display: flex;
            flex-direction: column;
            background-color: #f8f9fa;
            font-family: Arial, sans-serif;
        }
        #canvas {
            flex-grow: 1;
            border-bottom: 1px solid #ccc;
        }
        #toolbar {
            padding: 10px;
            background-color: #fff;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        button {
            padding: 8px 15px;
            border: 1px solid #007bff;
            background-color: #007bff;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        }
        button:hover {
            background-color: #0056b3;
        }
        #error-container {
            display: none;
            padding: 20px;
            color: #721c24;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="canvas"></div>
    <div id="toolbar">
        <button id="download-bpmn">下载 BPMN (XML)</button>
        <button id="download-svg">下载 SVG 图像</button>
    </div>
    <div id="error-container">
        <h3>加载流程图失败</h3>
        <p id="error-message"></p>
    </div>

    <!-- 引入 bpmn-js 库 -->
    <script src="https://unpkg.com/bpmn-js@17.0.2/dist/bpmn-viewer.development.js"></script>

    <script>
        // 1. 获取URL参数中的BPMN XML数据
        const urlParams = new URLSearchParams(window.location.search);
        const bpmnDataBase64 = urlParams.get('bpmn');

        const canvas = document.getElementById('canvas');
        const errorContainer = document.getElementById('error-container');
        const errorMessageElem = document.getElementById('error-message');

        let bpmnViewer;

        // 健壮的代码风格：使用异步函数和try-catch处理错误
        async function renderBPMN() {
            if (!bpmnDataBase64) {
                showError("URL中未提供BPMN数据。");
                return;
            }

            let bpmnXML;
            try {
                // Base64解码
                bpmnXML = atob(bpmnDataBase64);
            } catch (e) {
                showError("BPMN数据解码失败，请检查数据格式。错误: " + e.message);
                return;
            }
            
            // 2. 初始化 BpmnJS 查看器
            bpmnViewer = new BpmnJS({
                container: '#canvas'
            });

            try {
                // 3. 导入并渲染XML [[342]][[401]]
                await bpmnViewer.importXML(bpmnXML);
                
                // 渲染成功，调整视图
                const canvasInstance = bpmnViewer.get('canvas');
                canvasInstance.zoom('fit-viewport');
                
                // 绑定下载事件
                setupDownloadButtons();

            } catch (err) {
                // 捕获 bpmn-js 的导入错误 [[102]][[346]]
                showError("BPMN XML 渲染失败，请检查XML是否符合BPMN 2.0规范。错误详情: " + err.message);
            }
        }

        function showError(message) {
            canvas.style.display = 'none';
            document.getElementById('toolbar').style.display = 'none';
            errorMessageElem.textContent = message;
            errorContainer.style.display = 'block';
        }

        // 4. 实现下载功能 [[101]][[402]][[406]]
        function setupDownloadButtons() {
            const downloadBPMNButton = document.getElementById('download-bpmn');
            const downloadSVGButton = document.getElementById('download-svg');

            const download = (filename, data, mimeType) => {
                const blob = new Blob([data], { type: mimeType });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = filename;
                document.body.appendChild(a);
                a.click();
                setTimeout(() => {
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                }, 0);
            };

            downloadBPMNButton.addEventListener('click', async () => {
                try {
                    const { xml } = await bpmnViewer.saveXML({ format: true });
                    download('process.bpmn', xml, 'application/xml');
                } catch (err) {
                    alert('无法导出BPMN XML: ' + err.message);
                }
            });

            downloadSVGButton.addEventListener('click', async () => {
                try {
                    const { svg } = await bpmnViewer.saveSVG();
                    download('process.svg', svg, 'image/svg+xml');
                } catch (err) {
                    alert('无法导出SVG图像: ' + err.message);
                }
            });
        }

        // 执行渲染
        renderBPMN();
    </script>
</body>
</html>
